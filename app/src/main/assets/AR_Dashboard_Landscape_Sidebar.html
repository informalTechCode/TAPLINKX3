<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TapLinkX3 Dashboard Â· Landscape + Sidebar</title>
  <style>
    :root {
      --bg: #000000;
      --bg-2: #000000;
      --card: #0a0a0a;
      --accent: #f5f5f5;
      --accent-2: #bdbdbd;
      --text: #f5f5f5;
      --muted: #9a9a9a;
      --brightness: 1;
      --scale: 1;
      --radius: 18px;
      --icon-size: 22px;
      --shadow: 0 8px 24px rgba(0, 0, 0, .6), inset 0 1px 0 rgba(255, 255, 255, .02);
    }

    html,
    body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: system-ui, Segoe UI, Roboto, sans-serif;
    }

    body {
      display: flex;
      justify-content: center;
      overflow: hidden;
    }

    /* Portrait lock */
    .rotate {
      display: none;
      position: fixed;
      inset: 0;
      align-items: center;
      justify-content: center;
      color: #fff;
      background: rgba(0, 0, 0, .95);
      z-index: 1000;
      text-align: center;
      padding: 24px
    }

    .rotate .box {
      border: 1px solid rgba(255, 255, 255, .15);
      border-radius: 14px;
      padding: 18px 22px;
      background: rgba(255, 255, 255, .05);
      box-shadow: 0 10px 28px rgba(0, 0, 0, .45)
    }

    .rotate h1 {
      margin: 0 0 8px 0;
      font-size: 18px
    }

    .rotate p {
      margin: 0;
      font-size: 13px;
      opacity: .85
    }

    @media (orientation:portrait) {
      .hud {
        display: none !important;
      }

      .rotate {
        display: flex;
      }
    }

    .hud {
      width: 100vw;
      max-width: 960px;
      margin: 0 auto;
      height: 100vh;
      max-height: 480px;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      scroll-behavior: smooth;
      filter: brightness(var(--brightness));
      transform: scale(var(--scale));
      padding: 0 8px 16px;
      box-sizing: border-box;
      touch-action: none;
    }

    .topbar {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(255, 255, 255, .05);
      border-bottom: 1px solid rgba(255, 255, 255, .08);
      position: sticky;
      top: 0;
      backdrop-filter: blur(10px);
      z-index: 5;
      flex-wrap: wrap;
    }

    .topbar-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
    }

    .btn {
      border: none;
      background: rgba(255, 255, 255, .08);
      padding: 8px 12px;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none
    }

    .search {
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .15);
      border-radius: 10px;
      padding: 8px 10px;
      color: var(--text);
      outline: none;
      min-width: 140px;
      flex: 1;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
      min-height: 0
    }

    @media (max-width:820px) {
      .content {
        grid-template-columns: 1fr
      }

      #rightPane {
        width: 100%
      }
    }

    .card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px
    }

    .card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .8px
    }

    /* Sections left column */
    .section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 8px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--text);
    }

    .section::after {
      content: "";
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, rgba(255, 255, 255, .25), rgba(255, 255, 255, .05));
      border-radius: 999px
    }

    .section .label {
      filter: drop-shadow(0 0 6px var(--sec-glow, rgba(255, 255, 255, .25)));
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .sec-nav {
      --sec-glow: #7ecbff
    }

    .sec-social {
      --sec-glow: #69f0ae
    }

    .sec-music {
      --sec-glow: #ffea7f
    }

    .sec-creative {
      --sec-glow: #d0a8ff
    }

    .sec-prod {
      --sec-glow: #7fffd4
    }

    .sec-llm {
      --sec-glow: #7ab8ff
    }

    .sec-aimusic {
      --sec-glow: #a9ff7a
    }

    .sec-aivideo {
      --sec-glow: #ff7fe8
    }

    .sec-aivideo {
      --sec-glow: #ff7fe8
    }

    .sec-voice {
      --sec-glow: #ffb97f
    }

    .sec-util {
      --sec-glow: #e0e0e0
    }

    /* Apps 2 columns inside each category */
    .apps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 6px
    }

    @media (max-width:600px) {
      .apps {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr))
      }
    }

    .app {
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: 14px;
      padding: 10px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, .03);
      cursor: pointer;
      color: var(--text);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      min-height: 0;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent
    }

    .app:hover {
      transform: translateY(-1px) scale(1.03);
      border-color: rgba(255, 255, 255, .25);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .35), 0 0 0 1px rgba(255, 255, 255, .06)
    }

    .app:active {
      transform: scale(.99)
    }

    .app img {
      width: var(--icon-size);
      height: var(--icon-size);
      flex: 0 0 var(--icon-size);
      object-fit: contain;
      border-radius: 4px
    }



    .app span {
      color: var(--text);
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn {
      color: var(--text)
    }

    .card,
    .card * {
      color: inherit
    }

    .btn {
      border: none;
      background: rgba(255, 255, 255, .08);
      padding: 8px 12px;
      border-radius: 10px;
      color: var(--text);
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      user-select: none
    }

    .btn:hover,
    .btn:focus-visible {
      background: rgba(255, 255, 255, .16);
      outline: none;
    }

    .btn:active {
      transform: translateY(1px);
    }

    .search {
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .15);
      border-radius: 10px;
      padding: 8px 10px;
      color: var(--text);
      outline: none;
      min-width: 140px;
      flex: 1;
    }

    .content {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
      padding: 10px;
      box-sizing: border-box;
      min-height: 0
    }

    @media (max-width:820px) {
      .content {
        grid-template-columns: 1fr
      }

      #rightPane {
        width: 100%
      }
    }

    .card {
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px
    }

    .card h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: .8px
    }

    /* Sections left column */
    .section {
      display: flex;
      align-items: center;
      gap: 10px;
      margin: 10px 0 8px;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--text);
    }

    .section::after {
      content: "";
      flex: 1;
      height: 1px;
      background: linear-gradient(90deg, rgba(255, 255, 255, .25), rgba(255, 255, 255, .05));
      border-radius: 999px
    }

    .section .label {
      filter: drop-shadow(0 0 6px var(--sec-glow, rgba(255, 255, 255, .25)));
      display: inline-flex;
      align-items: center;
      gap: 6px
    }

    .sec-nav {
      --sec-glow: #7ecbff
    }

    .sec-social {
      --sec-glow: #69f0ae
    }

    .sec-music {
      --sec-glow: #ffea7f
    }

    .sec-creative {
      --sec-glow: #d0a8ff
    }

    .sec-prod {
      --sec-glow: #7fffd4
    }

    .sec-llm {
      --sec-glow: #7ab8ff
    }

    .sec-aimusic {
      --sec-glow: #a9ff7a
    }

    .sec-aivideo {
      --sec-glow: #ff7fe8
    }

    .sec-aivideo {
      --sec-glow: #ff7fe8
    }

    .sec-voice {
      --sec-glow: #ffb97f
    }

    .sec-util {
      --sec-glow: #e0e0e0
    }

    /* Apps 2 columns inside each category */
    .apps {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 10px;
      margin-bottom: 6px
    }

    @media (max-width:600px) {
      .apps {
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr))
      }
    }

    .app {
      border: 1px solid rgba(255, 255, 255, .1);
      border-radius: 14px;
      padding: 10px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255, 255, 255, .03);
      cursor: pointer;
      color: var(--text);
      transition: transform .15s ease, box-shadow .2s ease, border-color .2s ease;
      width: 100%;
      box-sizing: border-box;
      min-width: 0;
      min-height: 0;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent
    }

    .app:hover {
      transform: translateY(-1px) scale(1.03);
      border-color: rgba(255, 255, 255, .25);
      box-shadow: 0 10px 24px rgba(0, 0, 0, .35), 0 0 0 1px rgba(255, 255, 255, .06)
    }

    .app:active {
      transform: scale(.99)
    }

    .app img {
      width: var(--icon-size);
      height: var(--icon-size);
      flex: 0 0 var(--icon-size);
      object-fit: contain;
      border-radius: 4px
    }

    [data-theme="light"] {
      --bg: #f6f8fc;
      --bg-2: #ffffff;
      --card: #ffffff;
      --accent: #0a84ff;
      --accent-2: #2563eb;
      --text: #0b0f1a;
      --muted: #4a5b76
    }

    .app span {
      color: var(--text);
      flex: 1;
      min-width: 0;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .btn {
      color: var(--text)
    }

    .card,
    .card * {
      color: inherit
    }

    [data-theme="dark"] .card h3 {
      color: var(--muted)
    }

    .hud {
      scrollbar-gutter: stable;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, .35) transparent;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
    }

    .hud::-webkit-scrollbar {
      width: 10px;
    }

    .hud::-webkit-scrollbar-track {
      background: transparent;
    }

    .hud::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, .25);
      border-radius: 999px;
      border: 2px solid transparent;
      background-clip: padding-box;
    }

    .app {
      position: relative;
    }

    .app-actions {
      margin-left: auto;
      display: none;
      gap: 6px;
    }

    .icon-btn {
      border: 1px solid rgba(255, 255, 255, .2);
      background: rgba(255, 255, 255, .1);
      color: var(--text);
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
    }

    .icon-btn.danger {
      border-color: rgba(255, 90, 90, .6);
      color: #ff9b9b;
    }

    body[data-editing="true"] .app-actions {
      display: flex;
    }

    body[data-editing="true"] .app {
      cursor: default;
    }

    body[data-editing="true"] .app:hover {
      transform: none;
      border-color: rgba(255, 255, 255, .1);
      box-shadow: none;
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .modal.hidden {
      display: none;
    }

    .modal-card {
      width: min(420px, 92vw);
      background: var(--card);
      border: 1px solid rgba(255, 255, 255, .15);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .modal-card h3 {
      margin: 0;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: .8px;
      color: var(--muted);
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 12px;
    }

    .field input,
    .field select {
      background: rgba(255, 255, 255, .08);
      border: 1px solid rgba(255, 255, 255, .15);
      border-radius: 10px;
      padding: 8px 10px;
      color: var(--text);
      outline: none;
    }

    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 4px;
    }

    .helper {
      font-size: 11px;
      color: var(--muted);
    }

    .error {
      font-size: 11px;
      color: #ff9b9b;
    }

    .sec-custom {
      --sec-glow: #7aa6ff;
    }

    [data-theme="dark"] {
      --bg: #000000;
      --bg-2: #000000;
      --card: #0a0a0a;
      --accent: #f5f5f5;
      --accent-2: #bdbdbd;
      --text: #f5f5f5;
      --muted: #9a9a9a;
      --shadow: 0 8px 24px rgba(0, 0, 0, .6), inset 0 1px 0 rgba(255, 255, 255, .02);
    }

    [data-theme="dark"] .topbar {
      background: rgba(0, 0, 0, .7);
      border-bottom: 1px solid rgba(255, 255, 255, .08);
    }

    [data-theme="dark"] .section {
      --sec-glow: rgba(255, 255, 255, .2);
    }
  </style>
</head>

<body>
  <div class="rotate">
    <div class="box">
      <h1>Rotate your device</h1>
      <p>This dashboard is optimized for landscape orientation.</p>
    </div>
  </div>

  <div class="hud" data-taplink-scroll="true">
    <div class="topbar">
      <strong style="color:var(--text)">TapLinkX3 Dashboard</strong>
      <div style="flex:1"></div>
      <div class="topbar-actions">
        <button class="btn" id="editToggle" type="button">Edit Links</button>
        <button class="btn" id="addLink" type="button">Add Link</button>

      </div>
      <input id="appSearch" class="search" placeholder="Filter apps." />
    </div>

    <div class="content">
      <!-- Left: Categories (single column), each with 2-column apps -->
      <div class="card" id="leftPane">
        <h3>Apps</h3>
        <div id="appContainer"></div>
      </div>
    </div>
  </div>

  <div id="linkModal" class="modal hidden" role="dialog" aria-modal="true">
    <div class="modal-card">
      <h3 id="modalTitle">Add Link</h3>
      <form id="linkForm">
        <label class="field">Name
          <input id="linkName" type="text" autocomplete="off" />
        </label>
        <label class="field">URL
          <input id="linkUrl" type="text" autocomplete="off" />
        </label>
        <label class="field">Category
          <select id="linkGroup"></select>
        </label>
      </form>
      <div id="linkError" class="error"></div>
      <div class="helper">Tip: If you omit https://, it is added automatically.</div>
      <div class="modal-actions">
        <button class="btn" type="button" id="cancelLink">Cancel</button>
        <button class="btn" type="submit" form="linkForm" id="saveLink">Save</button>
      </div>
    </div>
  </div>

  <script>
    /* Prevent context menu on button clicks (avoids WebView popups) */
    document.addEventListener('contextmenu', (e) => {
      if (e.target.closest('button')) { e.preventDefault(); }
    });

    const interactiveSelector = 'button, input, textarea, select, .app, .icon-btn';
    document.addEventListener('touchmove', (e) => {
      if (e.target.closest(interactiveSelector)) { return; }
      e.preventDefault();
    }, { passive: false });

    /* Theme */


    /* Apps list */
    const storageKey = 'dashboardLinksV1';
    const defaultApps = {
      // Social & Messaging
      gmessages: { name: 'Google Messages', url: 'https://messages.google.com/web/welcome' },
      discord: { name: 'Discord', url: 'https://discord.com/app' },
      whatsapp: { name: 'WhatsApp', url: 'https://web.whatsapp.com' },
      instagram: { name: 'Instagram', url: 'https://www.instagram.com' },
      telegram: { name: 'Telegram', url: 'https://web.telegram.org' },
      tiktok: { name: 'TikTok', url: 'https://www.tiktok.com' },

      // Media & Search
      youtube: { name: 'YouTube', url: 'https://www.youtube.com' },
      informaltech: { name: 'Informal Tech', url: 'https://www.youtube.com/@informal-tech' },
      gmaps: { name: 'Google Maps', url: 'https://www.google.com/maps' },
      minijuegos: { name: 'Minijuegos', url: 'https://www.minijuegos.com' },

      // Music Streaming
      ytmusic: { name: 'YouTube Music', url: 'https://music.youtube.com' },
      spotify: { name: 'Spotify', url: 'https://open.spotify.com' },
      applemusic: { name: 'Apple Music', url: 'https://music.apple.com' },
      tidal: { name: 'Tidal', url: 'https://listen.tidal.com' },
      deezer: { name: 'Deezer', url: 'https://www.deezer.com' },
      audiomack: { name: 'Audiomack', url: 'https://audiomack.com' },
      soundcloud: { name: 'SoundCloud', url: 'https://soundcloud.com' },

      // Creativity / Multimedia
      photopea: { name: 'Photopea (Photo)', url: 'https://www.photopea.com' },
      clipchamp: { name: 'Clipchamp (Video)', url: 'https://clipchamp.com/en/video-editor/' },
      bandlab: { name: 'BandLab (DAW)', url: 'https://www.bandlab.com' },
      wireframe: { name: 'Wireframe.cc', url: 'https://wireframe.cc' },
      kleki: { name: 'Kleki', url: 'https://kleki.com' },

      // Productivity / Docs
      todoist: { name: 'Todoist', url: 'https://www.todoist.com' },
      stackedit: { name: 'StackEdit (Text)', url: 'https://stackedit.io/app' },
      sejda: { name: 'Sejda PDF Editor', url: 'https://www.sejda.com/pdf-editor' },

      // LLMs / Chatbots
      gemini: { name: 'Gemini', url: 'https://gemini.google.com' },
      googleaistudio: { name: 'Google AI Studio', url: 'https://aistudio.google.com' },
      jules: { name: 'Jules (Code)', url: 'https://jules.google.com' },
      perplexity: { name: 'Perplexity', url: 'https://www.perplexity.ai' },
      chatgpt: { name: 'ChatGPT', url: 'https://chatgpt.com' },
      claude: { name: 'Claude', url: 'https://claude.ai' },
      deepseek: { name: 'DeepSeek', url: 'https://chat.deepseek.com' },
      grok: { name: 'Grok', url: 'https://grok.com' },

      // Utilities / Reference
      wikipedia: { name: 'Wikipedia', url: 'https://www.wikipedia.org' },
      translate: { name: 'Google Translate', url: 'https://translate.google.com' },
      wolfram: { name: 'WolframAlpha', url: 'https://www.wolframalpha.com' },

      // AI Music Generation
      suno: { name: 'Suno (AI Music)', url: 'https://suno.com' },
      udio: { name: 'Udio (AI Music)', url: 'https://www.udio.com' },
      stableaudio: { name: 'Stable Audio', url: 'https://stableaudio.com' },

      // AI Video Generation
      runway: { name: 'Runway (AI Video)', url: 'https://runwayml.com' },
      pika: { name: 'Pika (AI Video)', url: 'https://pika.art' },
      luma: { name: 'Luma Dream Machine', url: 'https://lumalabs.ai/dream-machine' },

      // AI Voice / Cloning
      elevenlabs: { name: 'ElevenLabs (Voice)', url: 'https://elevenlabs.io' },
      playht: { name: 'PlayHT (Voice)', url: 'https://play.ht' }
    };

    const defaultGroups = [
      { title: 'Navigation / Entertainment', cls: 'sec-nav', keys: ['youtube', 'informaltech', 'gmaps', 'minijuegos', 'tiktok'] },
      { title: 'AI / Chatbots', cls: 'sec-llm', keys: ['gemini', 'googleaistudio', 'jules', 'perplexity', 'chatgpt', 'claude', 'deepseek', 'grok'] },
      { title: 'Social / Communication', cls: 'sec-social', keys: ['gmessages', 'discord', 'whatsapp', 'instagram', 'telegram'] },
      { title: 'Music / Streaming', cls: 'sec-music', keys: ['ytmusic', 'spotify', 'applemusic', 'tidal', 'deezer', 'audiomack', 'soundcloud'] },
      { title: 'Creativity / Multimedia', cls: 'sec-creative', keys: ['photopea', 'clipchamp', 'bandlab', 'wireframe', 'kleki'] },
      { title: 'Productivity / Documents', cls: 'sec-prod', keys: ['todoist', 'stackedit', 'sejda'] },
      { title: 'Utilities / Reference', cls: 'sec-util', keys: ['wikipedia', 'translate', 'wolfram'] },
      { title: 'AI Music', cls: 'sec-aimusic', keys: ['suno', 'udio', 'stableaudio'] },
      { title: 'AI Video', cls: 'sec-aivideo', keys: ['runway', 'pika', 'luma'] },
      { title: 'AI Voice', cls: 'sec-voice', keys: ['elevenlabs', 'playht'] },
      { title: 'Custom Links', cls: 'sec-custom', keys: [] }
    ];

    function normalizeTitle(value) {
      if (!value) return '';
      const trimmed = String(value).trim();
      // Strip leading emojis/punctuation that can render as ? on some devices.
      return trimmed.replace(/^[^\p{L}\p{N}]+/gu, '').trim();
    }

    function sanitizeGroups(groups) {
      let changed = false;
      for (const g of groups) {
        const normalized = normalizeTitle(g.title);
        if (normalized && normalized !== g.title) {
          g.title = normalized;
          changed = true;
        }
      }
      return changed;
    }

    function mergeGroups(savedGroups) {
      const base = JSON.parse(JSON.stringify(defaultGroups));
      base.forEach(group => {
        group.title = normalizeTitle(group.title);
      });
      if (!Array.isArray(savedGroups)) {
        return base;
      }
      const byTitle = new Map(savedGroups.map(group => [normalizeTitle(group.title), group]));
      for (const group of base) {
        const saved = byTitle.get(normalizeTitle(group.title));
        if (saved && Array.isArray(saved.keys)) {
          group.keys = saved.keys;
        }
      }
      for (const saved of savedGroups) {
        const normalizedTitle = normalizeTitle(saved.title);
        if (!base.some(group => normalizeTitle(group.title) === normalizedTitle)) {
          base.push({ ...saved, title: normalizedTitle || saved.title });
        }
      }
      return base;
    }

    function loadState() {
      const fallbackGroups = JSON.parse(JSON.stringify(defaultGroups));
      fallbackGroups.forEach(g => {
        g.title = normalizeTitle(g.title);
      });
      const fallback = {
        apps: { ...defaultApps },
        groups: fallbackGroups
      };
      try {
        const saved = JSON.parse(localStorage.getItem(storageKey));
        if (saved && saved.apps) {
          return {
            apps: saved.apps,
            groups: mergeGroups(saved.groups)
          };
        }
      } catch (e) { }
      return fallback;
    }

    function persistState() {
      localStorage.setItem(storageKey, JSON.stringify(state));
    }

    let state = loadState();
    if (sanitizeGroups(state.groups)) {
      persistState();
    }

    const appContainer = document.getElementById('appContainer');
    const search = document.getElementById('appSearch');
    const editToggle = document.getElementById('editToggle');
    const addLink = document.getElementById('addLink');
    const linkModal = document.getElementById('linkModal');
    const linkForm = document.getElementById('linkForm');
    const linkName = document.getElementById('linkName');
    const linkUrl = document.getElementById('linkUrl');
    const linkGroup = document.getElementById('linkGroup');
    const modalTitle = document.getElementById('modalTitle');
    const linkError = document.getElementById('linkError');
    const cancelLink = document.getElementById('cancelLink');

    let isEditing = false;
    let editingKey = null;

    const specialIcons = {
      whatsapp: 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 256 256%22 width=%2220%22 height=%2220%22><path fill=%22%2325D366%22 d=%22M128 0a128 128 0 0 0-110 190L8 248l60-9A128 128 0 1 0 128 0Z"/><path fill=%22%23fff%22 d=%22M193 178c-9 4-21 9-34 5c-30-9-77-48-91-83c-7-17 2-31 7-36c4-4 9-5 12-5l8 1c3 1 6 9 7 12s5 12 5 12s1 3 0 5c-1 3-7 7-7 9s-1 3 1 6a142 142 0 0 0 25 30c18 16 31 21 35 22s5 0 7-2s8-10 10-13s5-3 8-2l20 9c3 1 5 3 5 5s-9 13-18 19Z"/></svg>'
    };

    function setEditingMode(enabled) {
      isEditing = enabled;
      document.body.dataset.editing = enabled ? 'true' : 'false';
      editToggle.textContent = enabled ? 'Done' : 'Edit Links';
      renderAll();
    }

    function normalizeUrl(value) {
      const trimmed = (value || '').trim();
      if (!trimmed) return '';
      if (/^[a-z]+:\/\//i.test(trimmed)) return trimmed;
      return `https://${trimmed}`;
    }

    function slugify(value) {
      return value.toLowerCase().replace(/[^a-z0-9]+/g, '').slice(0, 16) || 'link';
    }

    function makeKey(name) {
      const base = slugify(name);
      let key = base;
      let idx = 1;
      while (state.apps[key]) {
        key = `${base}${idx}`;
        idx += 1;
      }
      return key;
    }

    function removeFromGroups(key) {
      for (const g of state.groups) {
        g.keys = (g.keys || []).filter(k => k !== key);
      }
    }

    function getGroupTitleForKey(key) {
      for (const g of state.groups) {
        if ((g.keys || []).includes(key)) {
          return g.title;
        }
      }
      return state.groups[0]?.title || 'Custom Links';
    }

    function updateGroupOptions(selectedTitle) {
      linkGroup.innerHTML = '';
      for (const g of state.groups) {
        const opt = document.createElement('option');
        opt.value = g.title;
        opt.textContent = g.title;
        linkGroup.append(opt);
      }
      if (selectedTitle) {
        linkGroup.value = selectedTitle;
      }
    }

    function openModal(mode, key) {
      linkError.textContent = '';
      if (mode === 'edit') {
        editingKey = key;
        const data = state.apps[key];
        modalTitle.textContent = 'Edit Link';
        linkName.value = data?.name || '';
        linkUrl.value = data?.url || '';
        updateGroupOptions(getGroupTitleForKey(key));
      } else {
        editingKey = null;
        modalTitle.textContent = 'Add Link';
        linkName.value = '';
        linkUrl.value = '';
        updateGroupOptions('Custom Links');
      }
      linkModal.classList.remove('hidden');
      setTimeout(() => linkName.focus({ preventScroll: true }), 0);
    }

    function closeModal() {
      linkModal.classList.add('hidden');
    }

    function bindActivate(button, handler) {
      let lastActivate = 0;
      function activate(event) {
        const now = Date.now();
        if (now - lastActivate < 350) { return; }
        lastActivate = now;
        event.preventDefault();
        handler(event);
      }
      button.addEventListener('click', activate);
      button.addEventListener('pointerup', activate);
      button.addEventListener('touchend', activate);
    }

    function bindImmediate(button, handler) {
      let lastActivate = 0;
      function activate(event) {
        const now = Date.now();
        if (now - lastActivate < 350) { return; }
        lastActivate = now;
        event.preventDefault();
        event.stopPropagation();
        handler(event);
      }
      button.addEventListener('pointerdown', activate);
      button.addEventListener('click', activate);
    }

    bindImmediate(editToggle, () => setEditingMode(!isEditing));
    bindImmediate(addLink, () => openModal('add'));
    bindActivate(cancelLink, () => closeModal());
    linkModal.addEventListener('click', (e) => { if (e.target === linkModal) closeModal(); });
    [linkName, linkUrl, linkGroup].forEach((el) => {
      el.addEventListener('pointerup', () => el.focus({ preventScroll: true }));
      el.addEventListener('touchend', () => el.focus({ preventScroll: true }));
    });

    linkForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const name = (linkName.value || '').trim();
      const url = normalizeUrl(linkUrl.value);
      if (!name || !url) {
        linkError.textContent = 'Name and URL are required.';
        return;
      }
      const targetGroupTitle = linkGroup.value || 'Custom Links';
      if (editingKey) {
        state.apps[editingKey] = { name, url };
        removeFromGroups(editingKey);
        const group = state.groups.find(g => g.title === targetGroupTitle);
        if (group) { group.keys.push(editingKey); }
      } else {
        const key = makeKey(name);
        state.apps[key] = { name, url };
        const group = state.groups.find(g => g.title === targetGroupTitle);
        if (group) { group.keys.push(key); }
      }
      persistState();
      renderAll();
      closeModal();
    });

    function createAppButton(key, meta) {
      const app = document.createElement('div');
      app.className = 'app';
      app.dataset.app = key;
      app.title = meta.name;
      app.setAttribute('role', 'button');
      const img = document.createElement('img');
      if (specialIcons[key]) {
        img.src = specialIcons[key];
      } else if (meta.url) {
        try {
          const host = (new URL(meta.url)).hostname;
          img.src = `https://www.google.com/s2/favicons?domain=${host}&sz=64`;
        } catch (e) { }
      }
      const label = document.createElement('span');
      label.textContent = meta.name;
      const actions = document.createElement('div');
      actions.className = 'app-actions';

      const editBtn = document.createElement('button');
      editBtn.type = 'button';
      editBtn.className = 'icon-btn';
      editBtn.textContent = 'Edit';
      bindActivate(editBtn, (e) => {
        e.stopPropagation();
        openModal('edit', key);
      });

      const deleteBtn = document.createElement('button');
      deleteBtn.type = 'button';
      deleteBtn.className = 'icon-btn danger';
      deleteBtn.textContent = 'Delete';
      bindActivate(deleteBtn, (e) => {
        e.stopPropagation();
        if (!confirm('Delete this link?')) return;
        delete state.apps[key];
        removeFromGroups(key);
        persistState();
        renderAll();
      });

      actions.append(editBtn, deleteBtn);
      app.append(img, label, actions);
      bindActivate(app, () => {
        if (isEditing) return;
        if (!meta.url) return;
        const w = window.open(meta.url, '_blank', 'noopener');
        if (!w || w.closed) { window.location.href = meta.url; }
      });
      return app;
    }

    function addSection(title, cls) {
      const s = document.createElement('div');
      s.className = `section ${cls}`;
      const span = document.createElement('span');
      span.className = 'label';
      span.textContent = title;
      s.append(span);
      appContainer.append(s);
      const body = document.createElement('div');
      body.className = 'apps';
      appContainer.append(body);
      return body;
    }

    function renderAll() {
      appContainer.innerHTML = '';
      const q = (search?.value || '').trim().toLowerCase();
      for (const g of state.groups) {
        const body = addSection(g.title, g.cls);
        const items = (g.keys || []).map(k => ({ k, m: state.apps[k] })).filter(x => x.m);
        const filtered = q ? items.filter(x => x.m.name.toLowerCase().includes(q) || x.k.toLowerCase().includes(q)) : items;
        if (filtered.length) {
          for (const it of filtered) { body.append(createAppButton(it.k, it.m)); }
        } else {
          const ph = document.createElement('div');
          ph.className = 'muted';
          ph.textContent = '- no matches -';
          body.append(ph);
        }
      }
    }

    if (search) { search.addEventListener('input', renderAll); }
    setEditingMode(false);

    /* The Android scroll buttons issue scrollBy() calls, but this layout keeps the body fixed
       and scrolls the inner .hud container instead. Bridge those calls so scroll buttons work. */
    (function bridgeScrollByToHud() {
      const hud = document.querySelector('.hud');
      if (!hud) { return; }

      const originalScrollBy = window.scrollBy.bind(window);
      const originalScrollTo = window.scrollTo.bind(window);

      function normalizeScrollArgs(arg0, arg1) {
        if (typeof arg0 === 'object' && arg0) {
          return {
            left: Number(arg0.left || 0),
            top: Number(arg0.top || 0),
            behavior: arg0.behavior
          };
        }
        return {
          left: Number(arg0 || 0),
          top: Number(arg1 || 0)
        };
      }

      function scrollHudBy(left, top, behavior) {
        try {
          if (typeof hud.scrollBy === 'function') {
            hud.scrollBy({ left, top, behavior });
            return;
          }
        } catch (e) { }
        if (typeof left === 'number') { hud.scrollLeft += left; }
        if (typeof top === 'number') { hud.scrollTop += top; }
      }

      function scrollHudTo(left, top, behavior) {
        try {
          if (typeof hud.scrollTo === 'function') {
            hud.scrollTo({ left, top, behavior });
            return;
          }
        } catch (e) { }
        if (typeof left === 'number') { hud.scrollLeft = left; }
        if (typeof top === 'number') { hud.scrollTop = top; }
      }

      window.scrollBy = function (arg0, arg1) {
        const { left, top, behavior } = normalizeScrollArgs(arg0, arg1);
        scrollHudBy(left, top, behavior);
        return originalScrollBy(arg0, arg1);
      };

      window.scrollTo = function (arg0, arg1) {
        const { left, top, behavior } = normalizeScrollArgs(arg0, arg1);
        scrollHudTo(left, top, behavior);
        return originalScrollTo(arg0, arg1);
      };
    })();

    (function taplinkHudScrollReporter() {
      if (window.__taplinkNativeScrollReporterInstalled) { return; }
      window.__taplinkNativeScrollReporterInstalled = true;

      const hud = document.querySelector('.hud');
      if (!hud) { return; }

      let scheduled = false;
      function report() {
        const rangeX = Math.max(hud.scrollWidth || 0, hud.clientWidth || 0);
        const extentX = hud.clientWidth || 0;
        const offsetX = hud.scrollLeft || 0;
        const rangeY = Math.max(hud.scrollHeight || 0, hud.clientHeight || 0);
        const extentY = hud.clientHeight || 0;
        const offsetY = hud.scrollTop || 0;
        if (window.AndroidInterface && typeof window.AndroidInterface.onScrollMetrics === 'function') {
          window.AndroidInterface.onScrollMetrics(
            rangeX, extentX, offsetX, rangeY, extentY, offsetY
          );
        }
      }

      let trailingTimer = null;
      function scheduleTrailing() {
        if (trailingTimer !== null) { return; }
        trailingTimer = setTimeout(() => {
          trailingTimer = null;
          report();
        }, 250);
      }

      function schedule() {
        if (scheduled) { return; }
        scheduled = true;
        requestAnimationFrame(() => {
          scheduled = false;
          report();
          scheduleTrailing();
        });
      }

      window.__taplinkReportScrollMetrics = report;
      hud.addEventListener('scroll', schedule, { passive: true });
      window.addEventListener('resize', schedule);
      report();
    })();
  </script>
</body>

</html>
